# name: test/sql/function/test_geohash.test
# description: ST_GEOHASH test
# group: [function]

statement ok
LOAD 'build/release/extension/geo/geo.duckdb_extension';

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE geometries(g Geometry)

statement ok
INSERT INTO geometries VALUES('0101000000295C8FC2F5281440E17A14AE47E12540'), ('{"type":"Point","coordinates":[-71.064544,10.2323]}'), ('POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678))'),(NULL)

query R
select ST_GEOHASH(g) from geometries
----
s1gw4xw40eb3ur11nctj
d3v6nysrkngr51n0w0rt
drt2x3v
NULL

# hash with precision
query R
select ST_GEOHASH(g, 10) from geometries
----
s1gw4xw40e
d3v6nysrkn
drt2x3veft
NULL

# test with null and empty
statement ok
DELETE FROM geometries

statement ok
INSERT INTO geometries VALUES(''), (NULL)

query R
select ST_GEOHASH(g) from geometries
----
(empty)
NULL

query R
select ST_GEOHASH(g,20) from geometries
----
(empty)
NULL

query I
SELECT ST_GEOHASH(ST_MAKEPOINT(5.04, 10.94))
----
s1gw4xw40eb3ur11nctj

query I
SELECT ST_GEOHASH(ST_MAKEPOINT(5.04, 10.94), 25)
----
s1gw4xw40eb3ur11nctjtyk80

query I
SELECT ST_GEOHASH('0101000000295C8FC2F5281440E17A14AE47E12540')
----
s1gw4xw40eb3ur11nctj

query I
SELECT ST_GEOHASH('0101000000295C8FC2F5281440E17A14AE47E12540', 29)
----
s1gw4xw40eb3ur11nctjtyk800000

query I
SELECT ST_GEOHASH('010400000004000000010100000000000000000034400000000000003440010100000000000000000034400000000000003E4001010000000000000000003E400000000000003440010100000000000000008066400000000000805640')
----
(empty)

query I
SELECT ST_GEOHASH('010400000004000000010100000000000000000034400000000000003440010100000000000000000034400000000000003E4001010000000000000000003E400000000000003440010100000000000000008066400000000000805640', 10)
----
y1z0gs3y0z

query I
SELECT ST_GEOHASH('POLYGON((-71.17166 42.353675,-71.172026 42.354044,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.17112 42.354238,-71.17166 42.353675))')
----
drt2uq

query I
SELECT ST_GEOHASH('POLYGON((-71.17166 42.353675,-71.172026 42.354044,-71.17239 42.354358,-71.171794 42.354971,-71.170511 42.354855,-71.17112 42.354238,-71.17166 42.353675))', 20)
----
drt2uqqec401fwxu0phq

query I
SELECT ST_GEOHASH('01020000000100000000000000000041400000000000003540')
----
sg8pmwyjc7tx2qgmu5dz

query I
SELECT ST_GEOHASH('01020000000100000000000000000041400000000000003540', 27)
----
sg8pmwyjc7tx2qgmu5dz7p7zzzz

query I
SELECT ST_GEOHASH('0105000000020000000102000000080000000000000000806440000000000000F03F0000000000003240000000000000F03FB420DEC1FD8428403C6E02B76B220140E46FD1FFD6921D40E46FD1FFD6921540E46FD1FFD6921540E46FD1FFD6921D40F86D02B76B220140B420DEC1FD842840000000000000F03F0000000000003240000000000000F03F000000000040554001020000000700000000000000008064400000000000003F4000000000000047400000000000003F401F8877703F214440E42670BB26124040FE2DFADF5AB24140FE2DFADF5AB24140E42670BB261240402D8877703F2144400000000000003F4000000000000047400000000000003F400000000000003340')
----
(empty)

query I
SELECT ST_GEOHASH('0105000000020000000102000000080000000000000000806440000000000000F03F0000000000003240000000000000F03FB420DEC1FD8428403C6E02B76B220140E46FD1FFD6921D40E46FD1FFD6921540E46FD1FFD6921540E46FD1FFD6921D40F86D02B76B220140B420DEC1FD842840000000000000F03F0000000000003240000000000000F03F000000000040554001020000000700000000000000008064400000000000003F4000000000000047400000000000003F401F8877703F214440E42670BB26124040FE2DFADF5AB24140FE2DFADF5AB24140E42670BB261240402D8877703F2144400000000000003F4000000000000047400000000000003F400000000000003340', 1)
----
t

query I
SELECT ST_GEOHASH('LINESTRING(-71.160281 42.258729,-71.160837 42.259113,-71.161144 42.25932)')
----
drt2k

query I
SELECT ST_GEOHASH('LINESTRING(-71.160281 42.258729,-71.160837 42.259113,-71.161144 42.25932)', 10)
----
drt2ktn2ej

query I
SELECT ST_GEOHASH('SRID=4269;POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678))')
----
drt2x3v

query I
SELECT ST_GEOHASH('SRID=4269;POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678))', 3)
----
drt

query I
SELECT ST_GEOHASH('GEOMETRYCOLLECTION(POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678)),LINESTRING(-71.160281 42.258729,-71.160837 42.259113,-71.161144 42.25932))')
----
drt2

query I
SELECT ST_GEOHASH('GEOMETRYCOLLECTION(POLYGON((-71.040878 42.285678,-71.040943 42.2856,-71.04096 42.285752,-71.040878 42.285678)),LINESTRING(-71.160281 42.258729,-71.160837 42.259113,-71.161144 42.25932))', 11)
----
drt2qp3vdkg

statement error
SELECT ST_GEOHASH('aaa')

statement error
SELECT ST_GEOHASH('aaa', 2)

query I
SELECT ST_GEOHASH(NULL)
----
NULL

query I
SELECT ST_GEOHASH(NULL, 2)
----
NULL

query I
SELECT ST_GEOHASH('')
----
(empty)

# Invalid input: Geohash requires inputs in decimal degrees
statement error
SELECT ST_GEOHASH('POLYGON((0 0,0 150,150 150,150 0,0 0),(20 20,50 20,50 50,20 50,20 20))')

#test with invalid input
statement error
SELECT ST_GEOHASH(22)
